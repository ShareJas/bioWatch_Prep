// BIOWATCH SENSOR UNIT TEST — WAITS FOR YOU TO OPEN SERIAL MONITOR
#include <Arduino.h>
#include "sensor.h"
#include "constants.h"

int32_t irBuffer[MY_BUFFER_SIZE];
int32_t redBuffer[MY_BUFFER_SIZE];
int32_t spo2 = 0;
int32_t heartRate = 0;
bool validSpo2 = false;
bool validHeartRate = false;

SensorManager sensor;

void setup() {
  Serial.begin(115200);

  // MAGIC WAIT
  Serial.println("WAITING FOR SERIAL MONITOR — OPEN NOW!");
  while (!Serial) {
    delay(100);  // Wait forever until you open the monitor
  }
  delay(500);  // Extra safety

  Serial.println("\n=== BIOWATCH FINAL SENSOR UNIT TEST ===\n");

  if (!sensor.init()) {
    Serial.println("ERROR: MAX30102 not detected! Check wiring/I2C.");
    while (true) delay(1000);
  }
  Serial.println("1. MAX30102 initialized → PASS");

  // BETTER FAKE DATA — for 60 BPM and SpO2 ~98%
  for (int i = 0; i < MY_BUFFER_SIZE; i++) {
    float angle = i * 2 * PI / 100.0;  // exactly 1 beat per 100 samples = 60 bpm
    // Perfect physiological ratio: Red AC is ~55% of IR AC (R ≈ 0.55 → SpO2 ≈ 98%)
    irBuffer[i]  = 120000 + 15000 * sin(angle);
    redBuffer[i] = 110000 + 7200 * sin(angle);   // 48% of IR → SpO2 ≈ 98%
  }
  Serial.println("2. Perfect fake PPG data injected");

  sensor.applySmoothingToBuffers();
  sensor.checkSignalQuality() ?
    Serial.println("3. Signal quality check → PASS") :
    Serial.println("3. Signal quality check → FAILED (should pass)");

  sensor.calculateHRSpO2();
  Serial.printf("4. Result → HR: %ld bpm (%s) | SpO2: %ld%% (%s)\n",
                heartRate, validHeartRate ? "VALID" : "invalid",
                spo2, validSpo2 ? "VALID" : "invalid");

  if (validHeartRate && heartRate >= 50 && heartRate <= 70 &&
      validSpo2 && spo2 >= 95 && spo2 <= 100) {
    Serial.println("\nYOUR SENSOR CODE IS 100% PERFECT!");
    Serial.println("Upload your real main.cpp now — it's ready for real fingers!");
  } else {
    Serial.println("\nSomething still needs fixing — check thresholds/casting");
  }

  Serial.println("\nTest finished. You can now restore your real main.cpp");
  Serial.println("Run: copy src\\main.cpp.backup src\\main.cpp");
  while (true) delay(1000);  // Keep serial alive
}

void loop() {}